<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" />

    <title>Montana Glaciers</title>
    <link href="https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css" rel="stylesheet" />

    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            width: 100%;
            top: 0;
            bottom: 0;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script src="https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script>
        var map = L.map("map", {
            zoomSnap: 0.1,
            center: [46.56645, -110.32422],
            zoom: 6.9
        });

        // mapbox access token
        var accessToken =
            "pk.eyJ1IjoiYWxleGJ1Y2szMjgiLCJhIjoiY2szcDZsdmFsMW9rbDNubjMydm9rNGJpMyJ9.05szss9EHEoVBbGYajbPZA";

        // add mapbox tile layers using access token
        L.tileLayer(
            "https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=" +
            accessToken, {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: 18,
                id: "mapbox.light",
                accessToken: accessToken
            }
        ).addTo(map);

        const glacierData = d3.json('data/mt-glaciers.json');
        const montanaData = d3.json('data/mt-state.json')

        // use Promise to wait until data is all loaded
        Promise.all([glacierData, montanaData]).then(drawMap);

        function drawMap(data) {

            console.log(data)

            const glacier = data[0];
            const mtState = data[1];

            // add Montana to our map
            var montana = L.geoJson(mtState, {
                style: function (feature, layer) {
                    return {
                        color: "gray",
                        fillColor: "#448ee4",
                        fillOpacity: ".3",
                        weight: 1
                    };
                }

            }).addTo(map);

            // create glacier point markers, tooltip and add that cool info to map
            var glacierPoints = glacier.features.forEach(function (feature) {

                // create a new Leaflet marker for each
                let coords = feature.geometry.coordinates;
                let marker = L.marker([coords[1], coords[0]]);

                // access to tooltip info
                let glacierInfo = feature.properties.FEATURE_NAME
                let elevation = Number(feature.properties.ELEV_IN_FT)

                // bind tooltip info to markers
                marker.bindTooltip(
                    `<b>Name:</b> ${glacierInfo} <br> <b>Elevation:</b> ${elevation.toLocaleString()}`)

                // add all the nifty stuff to the map
                marker.addTo(map)

                // listen for user click
                marker.on('click', function (ev) {
                    // get marker coordinates
                    console.log(feature.geometry.coordinates); 

                    var clickedGlacierCoords = feature.geometry.coordinates
                    
                    getCoords(clickedGlacierCoords, mtState, glacier)
                }); // end event listener

            })

            function getCoords(clickedGlacierCoords) {
                //verify access to info
                console.log(clickedGlacierCoords)
                console.log(mtState)
                console.log(glacier)

                //call bearingToCentroid
                bearingToCentroid(clickedGlacierCoords, mtState, glacier)
            }

        } // end drawMap



        function bearingToCentroid(clickedGlacierCoords, mtState,  glacier) { //coords,
            // access to mtState, coords and glacier here
                console.log(glacier)
                console.log(mtState)
                console.log(clickedGlacierCoords)

            // coordinates for center point
            var polygon = turf.polygon(mtState.features[0].geometry.coordinates);
            console.log(polygon)

            // point feature at center of polygon
            var center = turf.centerOfMass(polygon);
            console.log(center)

            // add centerPoint marker to map
            var centerPoint = L.geoJson(center).addTo(map);

            // find bearing between the two points
            var point1 = turf.point(clickedGlacierCoords);
            var point2 = turf.point(center.geometry.coordinates);

            //    console.log(point2)

            var bearing = turf.bearing(point2, point1);
            console.log(bearing)

            // add bearing to centroid tooltip
            centerPoint.bindTooltip(
                    `<b>Bearing from County Center to Selected Location:</b> ${bearing.toLocaleString()}`)
                .openTooltip();

        } // end bearingToCentroid
    </script>
</body>

</html>